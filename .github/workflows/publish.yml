name: Publish to crates.io

on:
  push:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install cargo-edit for version management
      run: cargo install cargo-edit
    
    - name: Get current crate version from src/parquet-record/Cargo.toml
      id: current_version
      run: |
        cd src/parquet-record
        VERSION=$(grep -E "^version = " Cargo.toml | head -n1 | cut -d '"' -f2)
        echo "current_version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current crate version: $VERSION"
    
    - name: Get previous crate version from src/parquet-record/Cargo.toml
      id: previous_version
      run: |
        cd src/parquet-record
        PREV_VERSION=$(git show HEAD~1:src/parquet-record/Cargo.toml 2>/dev/null | grep -E "^version = " | head -n1 | cut -d '"' -f2 || echo "0.0.0")
        echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
        echo "Previous crate version: $PREV_VERSION"
    
    - name: Check if version changed
      id: version_check
      run: |
        if [ "${{ steps.current_version.outputs.current_version }}" != "${{ steps.previous_version.outputs.previous_version }}" ]; then
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "Version has changed from ${{ steps.previous_version.outputs.previous_version }} to ${{ steps.current_version.outputs.current_version }}"
        else
          echo "version_changed=false" >> $GITHUB_OUTPUT
          echo "Version has not changed"
        fi
    
    - name: Run tests
      if: steps.version_check.outputs.version_changed == 'true'
      run: |
        cd src/parquet-record
        cargo test --verbose
    
    - name: Login to crates.io
      if: steps.version_check.outputs.version_changed == 'true' && secrets.CARGO_REGISTRY_TOKEN != ''
      run: |
        cd src/parquet-record
        cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}
    
    - name: Publish to crates.io
      if: steps.version_check.outputs.version_changed == 'true' && secrets.CARGO_REGISTRY_TOKEN != ''
      run: |
        cd src/parquet-record
        cargo publish
    
    - name: Create Git tag for new version
      if: steps.version_check.outputs.version_changed == 'true' && secrets.CARGO_REGISTRY_TOKEN != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a v${{ steps.current_version.outputs.current_version }} -m "Release version ${{ steps.current_version.outputs.current_version }}"
        git push origin v${{ steps.current_version.outputs.current_version }}